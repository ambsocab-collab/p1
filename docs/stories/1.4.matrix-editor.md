# Story 1.4: AMFE Matrix Editor Component

## Status
approved

## Story
**As a** ingeniero de calidad,
**I want** editar la matriz AMFE directamente como una hoja de cálculo,
**so that** ingresar y modificar datos de análisis eficientemente.

## Acceptance Criteria
1. Tabla editable con columnas: función, modo de fallo, efecto, causa, controles actuales, S, O, D, NPR
2. Cálculo automático de NPR (S × O × D) al modificar S, O, o D
3. Navegación por teclado (tab, shift-tab, enter, arrows)
4. Validaciones de rango (1-10) para S, O, D
5. Auto-guardado al perder foco de celda
6. Opción de agregar/eliminar filas dinámicamente
7. Indicadores visuales para NPRs críticos (color coding)

## Tasks / Subtasks
- [ ] Task 1: Create editable table component (AC: 1)
  - [ ] Create AMFEMatrix component in apps/web/src/components/amfe/AMFEMatrix.tsx
  - [ ] Define table columns: function, failure_mode, failure_effect, failure_cause, current_controls, severity, occurrence, detection, npr
  - [ ] Implement editable cells with input/text areas
  - [ ] Make NPR column read-only (calculated)
  - [ ] Add row numbers column
- [ ] Task 2: Implement NPR calculation (AC: 2)
  - [ ] Create calculateNPR utility function in apps/web/src/utils/calculations.ts
  - [ ] Calculate NPR = severity × occurrence × detection
  - [ ] Update NPR immediately when S, O, or D changes
  - [ ] Add risk level calculation (low/medium/high/critical)
  - [ ] Display formatted NPR with color coding
- [ ] Task 3: Add keyboard navigation (AC: 3)
  - [ ] Implement Tab navigation to next cell
  - [ ] Implement Shift+Tab for previous cell
  - [ ] Implement Enter to move to next row
  - [ ] Implement Arrow keys for cell movement
  - [ ] Wrap navigation at table edges
  - [ ] Focus management for editing cells
- [ ] Task 4: Add input validation (AC: 4)
  - [ ] Create validateRating function in apps/web/src/utils/validations.ts
  - [ ] Validate S, O, D fields are integers between 1-10
  - [ ] Show inline validation errors
  - [ ] Prevent invalid input submission
  - [ ] Highlight invalid cells with red border
- [ ] Task 5: Implement auto-save functionality (AC: 5)
  - [ ] Create debounced save function (500ms delay)
  - [ ] Save on cell blur (focus loss)
  - [ ] Show "saving..." indicator during save
  - [ ] Show "saved" confirmation briefly
  - [ ] Handle save errors gracefully
- [ ] Task 6: Add row management (AC: 6)
  - [ ] Create addRow function to insert at specific position
  - [ ] Create deleteRow function with confirmation
  - [ ] Add "+" button to add new rows
  - [ ] Add delete button on each row
  - [ ] Update row numbers automatically
  - [ ] Maintain scroll position after row changes
- [ ] Task 7: Implement NPR color coding (AC: 7)
  - [ ] Define color thresholds: critical (>=240, red), high (>=120, orange), medium (>=60, yellow), low (<60, green)
  - [ ] Apply colors to NPR cell text and background
  - [ ] Add color legend in table header
  - [ ] Update colors immediately when NPR changes
  - [ ] Ensure WCAG contrast compliance

## Dev Notes

### Previous Story Insights
Stories 1.1-1.3 provide:
- Database connection and AMFE data models
- AMFE creation and management UI
- State management with Zustand
- CRUD operations for AMFEs and items

### Component Architecture
From components.md: [Source: architecture/components.md#amfe-editor-component]
- Core spreadsheet-like interface with real-time calculations
- Key interfaces: updateCell, addRow, deleteRow, calculateNPR, validateInput
- Dependencies: AMFE data store, state management
- Technology: React + TypeScript, Zustand, Tailwind CSS

### DataTable Pro Component
From design-system-implementation.md: [Source: architecture/design-system-implementation.md#datatable-pro-component]
- Base table component with editing capabilities
- Features: keyboard navigation, auto-save, frozen headers, color coding
- Props: editable, onCellEdit, keyboardNavigation, autoSave, nprColorCoding
- Virtual scrolling for performance with large datasets

### Cell Editing Pattern
From frontend-architecture.md: [Source: architecture/frontend-architecture.md#component-template]
- Use useCallback for cell edit handlers
- Validate inputs before updating state
- Calculate NPR automatically when ratings change
- Update both local state and Zustand store

### State Management
From frontend-architecture.md: [Source: architecture/frontend-architecture.md#state-management-architecture]
- Use amfeStore for current AMFE and items
- Implement optimistic updates
- Sync with Supabase through service layer
- Handle loading and error states

### Performance Considerations
- Virtual scrolling for large datasets (>100 rows)
- Debounced auto-save to prevent excessive API calls
- Memoized row components to prevent unnecessary re-renders
- Efficient keyboard navigation with refs

### Keyboard Navigation
Implement event handlers:
- onKeyDown for Tab, Shift+Tab, Enter, Arrow keys
- preventDefault for custom behavior
- Focus management with useRef
- Cell selection and editing states

### Validation Rules
From data-models.md: [Source: architecture/data-models.md#amfeitem]
- Severity, Occurrence, Detection: integers 1-10
- Function, Failure Mode, Effect, Cause, Controls: required text fields
- NPR: calculated, read-only
- Risk Level: derived from NPR thresholds

### Color Coding Scheme
- Critical (NPR >= 240): red-600 text, red-50 background
- High (120 <= NPR < 240): orange-600 text, orange-50 background
- Medium (60 <= NPR < 120): yellow-600 text, yellow-50 background
- Low (NPR < 60): green-600 text, green-50 background

### Auto-save Implementation
- Use lodash.debounce or custom debounce function
- Save on blur (onBlur event)
- Save on Enter key press
- Show save status in UI
- Queue changes for offline support

### Row Management
- Insert row at specific index (not just at end)
- Maintain row_number field
- Update all subsequent row numbers
- Confirmation dialog for delete
- Undo for delete operation

### File Locations
Based on unified-project-structure.md: [Source: architecture/unified-project-structure.md]
- AMFEMatrix component: apps/web/src/components/amfe/AMFEMatrix.tsx
- AMFERow component: apps/web/src/components/amfe/AMFERow.tsx
- Utilities: apps/web/src/utils/calculations.ts, validations.ts
- Styles: Tailwind CSS classes in components

### API Integration
- Use APIClient from Story 1.2
- Batch update AMFE items for efficiency
- Handle concurrent edits
- Offline queue for failed saves

### Accessibility
- Semantic table structure with <table>, <thead>, <tbody>
- ARIA labels for editable cells
- Keyboard navigation support
- Focus indicators
- Screen reader announcements for changes

### Error Handling
- Show inline errors for validation
- Toast notifications for save errors
- Retry mechanism for failed saves
- Data recovery from local cache

### Testing
- Unit tests for NPR calculation
- Integration tests for keyboard navigation
- E2E tests for edit/save flow
- Performance tests with large datasets
- Accessibility testing with screen readers

## Testing
### Testing Standards
- Test location: apps/web/tests/components/
- Framework: Jest + React Testing Library
- Test cell editing, validation, calculation
- Mock API calls for save operations
- Test keyboard navigation scenarios
- Performance tests with 1000+ rows

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-31 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
<!-- To be populated by dev agent -->

### Debug Log References
<!-- To be populated by dev agent -->

### Completion Notes List
<!-- To be populated by dev agent -->

### File List
<!-- To be populated by dev agent -->

## QA Results
<!-- To be populated by QA agent -->