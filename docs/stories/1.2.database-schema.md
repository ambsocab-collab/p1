# Story 1.2: Database Schema & Authentication Setup

## Status
Approved

## Story
**As a** desarrollador,
**I want** definir y crear el schema de base de datos para AMFEs con autenticación opcional,
**so that** poder persistir y consultar datos de análisis eficientemente.

## Acceptance Criteria
1. Tablas en Supabase: users, fmeas, failure_modes, failure_causes, correctives_actions
2. Row Level Security configurado para acceso solo por dueño
3. Supabase Auth configurado con email/password (opcional para usuario)
4. Types de TypeScript generados automáticamente desde schema
5. API endpoints básicos funcionando (CRUD para fmeas)
6. Conexión entre frontend y Supabase establecida y probada

## Tasks / Subtasks
- [ ] Task 1: Create database schema in Supabase (AC: 1)
  - [ ] Create tables: amfes, amfe_items, corrective_actions, evidence, failure_modes, user_profiles
  - [ ] Define all columns with proper types and constraints
  - [ ] Add foreign key relationships
  - [ ] Create indexes for performance optimization
  - [ ] Add triggers for updated_at timestamps
- [ ] Task 2: Setup Row Level Security (RLS) (AC: 2)
  - [ ] Enable RLS on all user data tables
  - [ ] Create policies for authenticated users (own data only)
  - [ ] Create policies for anonymous users (created_by IS NULL)
  - [ ] Create cascading policies for related tables
  - [ ] Test RLS policies with different user contexts
- [ ] Task 3: Configure Supabase Auth (AC: 3)
  - [ ] Enable Supabase Auth in project settings
  - [ ] Configure email/password authentication
  - [ ] Create auth helper functions for sign up/sign in
  - [ ] Make authentication optional (allow anonymous usage)
  - [ ] Test both authenticated and anonymous flows
- [ ] Task 4: Generate TypeScript types (AC: 4)
  - [ ] Install Supabase CLI locally
  - [ ] Generate types from database schema
  - [ ] Save types to packages/shared/src/types/database.ts
  - [ ] Update type exports in package index
  - [ ] Verify types compile correctly
- [ ] Task 5: Create basic API endpoints (AC: 5)
  - [ ] Create Supabase client service in frontend
  - [ ] Implement CRUD operations for AMFEs table
  - [ ] Create service functions: getAMFEs, createAMFE, updateAMFE, deleteAMFE
  - [ ] Add error handling and type safety
  - [ ] Test all CRUD operations
- [ ] Task 6: Establish frontend-supabase connection (AC: 6)
  - [ ] Create Supabase client configuration
  - [ ] Initialize client in App.tsx
  - [ ] Create auth context provider
  - [ ] Test connection with simple data fetch
  - [ ] Handle connection errors gracefully

## Dev Notes

### Previous Story Insights
Story 1.1 set up the project structure and environment variables. The Supabase project should already be created and configured in environment variables.

### Database Schema
From database-schema.md: [Source: architecture/database-schema.md]
- Tables to create: amfes, amfe_items, corrective_actions, evidence, failure_modes, user_profiles
- Use UUID primary keys with gen_random_uuid() defaults
- Include created_at and updated_at timestamps on all tables
- Generate NPR and risk_level columns automatically in amfe_items table
- JSONB metadata columns for flexibility

### Data Models
From data-models.md: [Source: architecture/data-models.md]
- AMFE: Core document with name, type (DFMEA/PFMEA), status, metadata
- AMFEItem: Individual analysis rows with S/O/D ratings and calculated NPR
- CorrectiveAction: Action tracking with costs, status, ROI calculation
- Evidence: File attachments for actions
- FailureMode: Library of common failure modes
- User: Optional user profiles with preferences

### Row Level Security Policies
From database-schema.md: [Source: architecture/database-schema.md#row-level-security-policies]
- Users can only access their own data (created_by = auth.uid())
- Anonymous users can access local data (created_by IS NULL)
- Policies cascade to related tables through parent relationships
- Failure modes table is publicly readable

### API Specification
From api-specification.md: [Source: architecture/api-specification.md]
- REST API endpoints for AMFE CRUD operations
- OpenAPI 3.0 specification with all schemas defined
- Authentication optional (Bearer token or anonymous)
- Basic endpoints: GET/POST/PUT/DELETE /amfes

### TypeScript Types Generation
From tech-stack.md: [Source: architecture/tech-stack.md]
- Use Supabase CLI to generate types automatically
- Store in packages/shared for use across frontend and backend
- Types should match database schema exactly

### Frontend Integration
From frontend-architecture.md: [Source: architecture/frontend-architecture.md#api-client-setup]
- Create Supabase client service in apps/web/src/services/supabase.ts
- Use environment variables for configuration
- Provide typed client based on generated types

### File Locations
Based on unified-project-structure.md: [Source: architecture/unified-project-structure.md]
- Database types: packages/shared/src/types/database.ts
- Supabase client: apps/web/src/services/supabase.ts
- Auth context: apps/web/src/providers/AuthProvider.tsx
- API services: apps/web/src/services/amfe.ts

### Testing
- Database testing using Supabase CLI
- Frontend unit tests for API services
- Integration tests for CRUD operations
- Test both authenticated and anonymous access patterns

## Testing
### Testing Standards
- Database tests: Use Supabase CLI testing features
- Frontend tests: Jest + React Testing Library for service functions
- Test RLS policies with different user contexts
- Integration tests: Verify full CRUD cycle
- Location: apps/web/tests/services/

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-31 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
<!-- To be populated by dev agent -->

### Debug Log References
<!-- To be populated by dev agent -->

### Completion Notes List
<!-- To be populated by dev agent -->

### File List
<!-- To be populated by dev agent -->

## QA Results
<!-- To be populated by QA agent -->