# Story 1.5: Failure Modes Library Integration

## Status
Approved

## Story
**As a** usuario de calidad,
**I want** acceder y utilizar una biblioteca pre-cargada de 100+ modos de fallo comunes,
**so that** acelerar el análisis y asegurar cobertura completa.

## Acceptance Criteria
1. Biblioteca de 100+ modos de fallo organizados por categoríamanufacturera
2. Búsqueda y filtrado de modos de fallo por texto y categoría
3. Función de autocompletado mientras escribe en campo de modo de fallo
4. Opción de agregar modos de fallo personalizados a biblioteca local
5. Pre-carga inicial de biblioteca en Supabase durante setup
6. UI tipo modal/popup para buscar y seleccionar modos de fallo

## Tasks / Subtasks
- [ ] Task 1: Create failure modes database table and seed data (AC: 1, 5)
  - [ ] Create failure_modes table (should exist from Story 1.2)
  - [ ] Create seed file with 100+ failure modes in infrastructure/supabase/seeds/
  - [ ] Organize failure modes by manufacturing categories (Assembly, Machining, Welding, etc.)
  - [ ] Include common_causes array and severity_default values
  - [ ] Add tags for better searchability
  - [ ] Run seed migration to populate database
- [ ] Task 2: Create failure modes API service (AC: 2)
  - [ ] Create FailureModeService in apps/web/src/services/failureModes.ts
  - [ ] Implement searchFailureModes function with text search
  - [ ] Implement getFailureModesByCategory function
  - [ ] Implement getFailureModeCategories function
  - [ ] Add caching for frequently accessed modes
- [ ] Task 3: Create autocomplete component (AC: 3)
  - [ ] Create AutocompleteInput component in apps/web/src/components/ui/AutocompleteInput.tsx
  - [ ] Implement debounced search (300ms delay)
  - [ ] Show dropdown with matching results
  - [ ] Handle keyboard navigation in dropdown
  - [ ] Add loading indicator during search
  - [ ] Handle no results state
- [ ] Task 4: Create failure modes selector modal (AC: 6)
  - [ ] Create FailureModeSelector component in apps/web/src/components/amfe/FailureModeSelector.tsx
  - [ ] Implement modal with search input and category filter
  - [ ] Display failure modes in scrollable list with categories
  - [ ] Show common causes and suggested severity for each mode
  - [ ] Add "Use Mode" button to select and insert
  - [ ] Add "Add to Library" button for custom modes
- [ ] Task 5: Integrate with matrix editor (AC: 3)
  - [ ] Modify AMFEMatrix component to show autocomplete on failure_mode field
  - [ ] Add "Browse Library" button to open selector modal
  - [ ] Pre-fill common_causes when failure mode selected
  - [ ] Pre-fill severity if default exists
  - [ ] Handle multiple selections for different rows
- [ ] Task 6: Add custom failure modes functionality (AC: 4)
  - [ ] Create AddCustomFailureMode component in apps/web/src/components/amfe/AddCustomFailureMode.tsx
  - [ ] Form fields: mode, category, common_causes, severity_default, tags
  - [ ] Save to user-specific library or local storage
  - [ ] Validate custom mode before saving
  - [ ] Show custom modes in search results with [Custom] indicator

## Dev Notes

### Previous Story Insights
Stories 1.1-1.4 provide:
- Database schema with failure_modes table
- AMFE matrix editor with editable cells
- API service infrastructure
- Component architecture

### Data Model
From data-models.md: [Source: architecture/data-models.md#failuremode]
- FailureMode interface with id, category, mode, common_causes, severity_default, tags
- Array of common causes for quick selection
- Optional severity_default for suggested rating

### Database Schema
From database-schema.md: [Source: architecture/database-schema.md#failure-modes-library-table]
- Table already created in Story 1.2
- Fields: category, mode, common_causes (array), severity_default, tags (array)
- Public read access via RLS policies
- Full-text search index on mode and tags

### API Endpoints
From api-specification.md: [Source: architecture/api-specification.md#failure-modes-library]
- GET /failure-modes with category and search query parameters
- Returns array of FailureMode objects
- Supports text search across mode and tags

### Manufacturing Categories
Categories to include in seed data:
- Assembly & Joining
- Machining & Cutting
- Welding & Bonding
- Surface Treatment
- Material Handling
- Electrical & Electronic
- Software & Systems
- Human Factors
- Environmental
- Quality Control

### Seed Data Examples
```sql
INSERT INTO failure_modes (category, mode, common_causes, severity_default, tags) VALUES
('Assembly & Joining', 'Loose Connection', ['Insufficient torque', 'Vibration', 'Thermal cycling'], 6, ARRAY['electrical', 'mechanical']),
('Machining & Cutting', 'Tool Wear', ['Excessive use', 'Wrong tool material', 'Inadequate cooling'], 5, ARRAY['tool', 'dimensional']),
('Welding & Bonding', 'Porosity', ['Contamination', 'Moisture', 'Wrong gas flow'], 7, ARRAY['weld', 'defect']);
```

### Autocomplete Implementation
- Use react-select or custom implementation
- Debounce search to prevent excessive API calls
- Cache results by search term
- Highlight matching text in results
- Show category in results for context

### Modal Component
- Use Headless UI Dialog for accessibility
- Two-column layout: search/filters left, results right
- Category pills for quick filtering
- Show 20 results with "Load More" pagination
- Click outside or ESC to close

### Integration Points
- Hook into AMFEMatrix component's failure_mode cells
- Pass selected mode data to parent component
- Auto-fill related fields (causes, severity)
- Maintain focus in matrix after selection

### Performance Considerations
- Cache failure modes in IndexedDB for offline use
- Pre-load common categories on app start
- Use virtual scroll for large result sets
- Compress tag data for faster transfer

### Accessibility
- Modal focus trapping
- Keyboard navigation in results
- ARIA labels for screen readers
- High contrast mode support
- Screen reader announcements for selections

### Error Handling
- Handle network errors gracefully
- Show "Try Again" option on failure
- Fall back to cached library if available
- Log errors for debugging

### File Locations
Based on unified-project-structure.md: [Source: architecture/unified-project-structure.md]
- Failure mode services: apps/web/src/services/failureModes.ts
- Autocomplete component: apps/web/src/components/ui/AutocompleteInput.tsx
- Selector modal: apps/web/src/components/amfe/FailureModeSelector.tsx
- Custom mode form: apps/web/src/components/amfe/AddCustomFailureMode.tsx
- Seed data: infrastructure/supabase/seeds/failure_modes.sql

### Testing
- Unit tests for search functionality
- Integration tests for autocomplete
- E2E tests for selection flow
- Performance tests with large library
- Accessibility tests with screen readers

## Testing
### Testing Standards
- Test location: apps/web/tests/components/
- Framework: Jest + React Testing Library
- Test autocomplete dropdown behavior
- Test modal interaction
- Mock API for failure modes service
- Test custom mode creation

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-31 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
<!-- To be populated by dev agent -->

### Debug Log References
<!-- To be populated by dev agent -->

### Completion Notes List
<!-- To be populated by dev agent -->

### File List
<!-- To be populated by dev agent -->

## QA Results
<!-- To be populated by QA agent -->